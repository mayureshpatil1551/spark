Solve using SQLite
A customer is considered retained in a given month if:
The customer placed at least one order in the current month AND also placed at least one order in the immediately previous month.
Important notes
Retention is calculated month over month
First month has no retention (no previous month to compare)
Multiple orders by the same customer in a month are counted only once

ðŸ“¦ Input Table -->
create table transactions(
order_id int,
cust_id int,
order_date date,
amount int
);
delete from transactions;
insert into transactions values 
(1,1,'2020-01-15',150)
,(2,1,'2020-02-10',150)
,(3,2,'2020-01-16',150)
,(4,2,'2020-02-25',150)
,(5,3,'2020-01-10',150)
,(6,3,'2020-02-20',150)
,(7,4,'2020-01-20',150)
,(8,5,'2020-02-20',150)
;

SQL -->

%sql
select month(t1.order_date) as monthh,count(distinct t2.cust_id) as dd
from transactions t1
left join transactions t2 on t1.cust_id = t2.cust_id
and datediff(month,t2.order_date,t1.order_date) = 1
group by month(t1.order_date)


Pyspark -->

%python
from pyspark.sql import functions as F

df1 = spark.table("transactions")
df2 = df1
# Alias your DataFrames
t1 = df1.alias("t1")
t2 = df2.alias("t2")
final_df = (
    t1.join(
        t2,
        (t1.cust_id == t2.cust_id) &
        (F.months_between(t1.order_date, t2.order_date) == 1),
        'left'
    )
    .groupBy(F.month(t1.order_date).alias("monthh"))
    .agg(F.countDistinct(t2.cust_id).alias("count_custs"))
)
final_df.show()

